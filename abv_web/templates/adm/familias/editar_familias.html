{% extends "../nav/index.html" %} {% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    {% block title %}Editar Familia - ABV ELECTRIC SUPPLY{% endblock %}
    {% block link_styles %}
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://kit.fontawesome.com/3365035c0e.js" crossorigin="anonymous"></script>
    {% endblock %}
  </head>
  <body>
    {% block cuerpo %}
    <div class="container-fluid py-4">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-light">
          <h3 class="mb-0 text-center">Gestión de Familias</h3>
        </div>

        <div class="card-body bg-white">
          <div class="d-flex justify-content-end mb-3">
            <button type="button" class="btn btn-success fw-bold" data-bs-toggle="modal" data-bs-target="#modalAddFamilia">
              <i class="fas fa-plus me-1"></i> Agregar
            </button>
          </div>
          <div class="card-body bg-white">
            <div class="table-responsive">
              <table id="familiasTable" class="table table-striped table-hover table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Familia</th>
                    <th>Descripción</th>
                    <th>Imagen</th>
                    <th>Marca Asociada</th>
                    <th>Categoría Asociada</th>
                    <th class="text-center">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for fam in familias %}
                  <tr>
                    <td>{{ fam.familia_name }}</td>
                    <td>{{ fam.familia_descripcion }}</td>
                    <td>
                      {% if fam.familia_url_img %}
                      <img src="/media-files/{{ fam.familia_url_img }}" alt="{{ fam.familia_name }}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover" />
                      {% else %}
                      No imagen
                      {% endif %}
                    </td>
                    <td>
                      {% if fam.marca %}
                      <span class="badge bg-primary me-1">{{ fam.marca.marca_name }}</span>
                      {% else %}
                      Ninguna
                      {% endif %}
                    </td>
                    <td>
                      {% if fam.categoria %}
                      <span class="badge bg-info me-1">{{ fam.categoria.categoria_name }}</span>
                      {% else %}
                      Ninguna
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <a href="{% url 'editar_familia' fam.id %}" class="btn btn-sm btn-warning me-1">
                        Editar <i class="bi bi-pencil-fill"></i>
                      </a>
                      <a href="{% url 'eliminar_familia' fam.id %}" class="btn btn-sm btn-danger">
                        Eliminar <i class="fas fa-trash-alt"></i>
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade show d-block" id="editFamiliaModal" tabindex="-1" aria-labelledby="editFamiliaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4">
          <div class="modal-header bg-primary text-white rounded-top-4">
            <h5 class="modal-title fw-bold" id="editFamiliaModalLabel">Editar Familia</h5>
            <a href="{% url 'familias' %}" class="btn-close btn-close-white"></a>
          </div>
          <form action="{% url 'editar_familia' familia.id %}" method="POST" enctype="multipart/form-data" class="p-3">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label fw-semibold">{{ formF.familia_name.label }}</label>
              {{ formF.familia_name }}
              {% for error in formF.familia_name.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">{{ formF.familia_descripcion.label }}</label>
              {{ formF.familia_descripcion }}
              {% for error in formF.familia_descripcion.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">{{ formF.familia_url_img.label }}</label>
              <div class="form-control p-2 rounded-3 shadow-sm">
                {{ formF.familia_url_img }}
              </div>
              {% if formF.familia_url_img.help_text %}
              <div class="form-text">{{ formF.familia_url_img.help_text }}</div>
              {% endif %}
              {% for error in formF.familia_url_img.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            {# Campo para la marca asociada (ForeignKey) #}
            <div class="mb-3">
              <label class="form-label fw-semibold">{{ formF.marca.label }}</label>
              {{ formF.marca }}
              {% if formF.marca.help_text %}
              <div class="form-text">{{ formF.marca.help_text }}</div>
              {% endif %}
              {% for error in formF.marca.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            {# Campo para la categoría asociada (ForeignKey) #}
            <div class="mb-3">
              <label class="form-label fw-semibold">{{ formF.categoria.label }}</label>
              {{ formF.categoria }}
              {% if formF.categoria.help_text %}
              <div class="form-text">{{ formF.categoria.help_text }}</div>
              {% endif %}
              {% for error in formF.categoria.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            {# Campo para el estado (statusFamilia) #}
            <div class="mb-3 form-check">
              {{ formF.statusFamilia }}
              <label class="form-check-label" for="{{ formF.statusFamilia.id_for_label }}">
                {{ formF.statusFamilia.label }}
              </label>
              {% for error in formF.statusFamilia.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>

            <div class="modal-footer border-0">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" onclick="window.location.href='{% url 'familias' %}'">Cancelar</button>
              <button type="submit" class="btn btn-primary fw-bold">Guardar cambios</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        $("#familiasTable").DataTable({
          language: {
            search: "Buscar:",
            lengthMenu: "Mostrar _MENU_ registros",
            zeroRecords: "No se encontraron registros",
            info: "Página _PAGE_ de _PAGES_",
            infoEmpty: "Sin registros",
            infoFiltered: "(filtrado de _MAX_ totales)",
            paginate: {
              first: "Primero",
              last: "Último",
              next: "Siguiente",
              previous: "Anterior",
            },
          },
          responsive: true,
          autoWidth: false,
          columnDefs: [{ targets: [0, 1, 2, 3, 4], orderable: true }, { targets: [5], orderable: false }],
        });

        // Mostrar modal de edición automáticamente
        var editModal = new bootstrap.Modal(document.getElementById("editFamiliaModal"));
        editModal.show();

        // Redirigir a la lista de familias cuando el modal se cierra
        $("#editFamiliaModal").on("hidden.bs.modal", function (e) {
          window.location.href = "{% url 'familias' %}";
        });
      });
    </script>
    {% endblock %}
  </body>
</html>